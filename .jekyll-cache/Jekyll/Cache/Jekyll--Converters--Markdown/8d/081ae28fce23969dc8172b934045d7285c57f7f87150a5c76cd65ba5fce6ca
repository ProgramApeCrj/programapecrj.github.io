I"¤'<p>å‰è¨€ï¼šè€åƒå±‚å¥—è·¯äº†ã€‚</p>

<h4 id="å¯¼èˆª">å¯¼èˆª</h4>
<ol>
  <li>åœºæ™¯æè¿°</li>
  <li>æš´åŠ›å†™æ³•</li>
  <li>ä¾æ ·ç”»ç“¢</li>
  <li>è¿›è¡Œä¼˜åŒ–</li>
  <li>è€ƒè™‘æ¼”è¿›</li>
  <li>å†ä¸€æ¬¡å°è£…</li>
  <li>æ€»ç»“</li>
</ol>

<p><br /></p>
<h1 id="1-åœºæ™¯æè¿°">1. åœºæ™¯æè¿°</h1>

<p>åœ¨å¼€å‘ä¸­ï¼Œå¾ˆå¤šæ—¶å€™è¦æ”¶é›†å°ç¨‹åºç”¨æˆ·çš„ä¸€äº›ä¸šåŠ¡ä¸ŠæŠ¥ï¼Œæ¯”å¦‚è¶³è¿¹ï¼Œç‚¹èµï¼Œè§‚çœ‹æ—¶é•¿ç­‰ç­‰ã€‚é€šè¿‡ä¸ŠæŠ¥åï¼Œå€ŸåŠ© kafka æ¥è¿›è¡Œæ¶ˆè´¹ã€‚</p>

<p>ç°åœ¨çš„åœºæ™¯æ˜¯è¿™æ ·çš„ï¼Œä¸šåŠ¡åˆ†ä¸ºå¤šç§ï¼Œä¼šå’Œå‰ç«¯çº¦å®šç›¸åº”çš„keyã€‚æ¯”å¦‚</p>
<ul>
  <li>10001 ä»£è¡¨è¶³è¿¹</li>
  <li>10002 ä»£è¡¨ç‚¹èµ</li>
  <li>10003 ä»£è¡¨æ”¯ä»˜</li>
  <li>ã€‚ã€‚ã€‚</li>
</ul>

<p>å¤§è‡´çš„æ ¼å¼å°±æ˜¯ {keyï¼šâ€10001â€, â€œcontentâ€:â€â€¦..â€, xx : â€œâ€¦â€}</p>

<p>è¦æ±‚å¯¹ä¸åŒ key éƒ½ç¼–å†™å¯¹åº”çš„ä¸€ä¸ªå¤„ç†è¿‡ç¨‹ï¼Œæˆ–å…¥åº“ï¼Œæˆ–åšç´¯åŠ ç­‰ç­‰ã€‚ã€‚è§„åˆ™ä¹Ÿå„ä¸ç›¸åŒã€‚</p>

<h1 id="2-æš´åŠ›å†™æ³•">2. æš´åŠ›å†™æ³•</h1>

<p>å…¶å®ä¸Šé¢çš„åœºæ™¯å¾ˆç®€å•ï¼Œä¸Šæ¥ä¸ç”¨æ€è€ƒå°±å¯ä»¥å†™äº†ï¼š</p>

<p>å†™ä¸‰ä¸ªåŠæ³•åˆ†åˆ«å¤„ç†ä¸åŒçš„ key</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func handle10001(msg Msg) {
   // todo å¤„ç†é€»è¾‘
}

func handle10002 (msg Msg) {
   // todo å¤„ç†é€»è¾‘
}

func handle10003 (msg Msg) {
   // todo å¤„ç†é€»è¾‘
}

</code></pre></div></div>
<p>ç„¶åæ¶ˆè´¹æ•°æ®çš„æ—¶å€™ç›´æ¥è°ƒç”¨</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func cus(msg Msg){
   if msg.key == "10001"{
      handle10001(msg)
   }else if msg.key == "10002"{
      handle10002(msg)
   }else if msg.key == "10003"{
      handle10003(msg)
   }
}


</code></pre></div></div>

<p><br /></p>
<h1 id="3-ä¾æ ·ç”»ç“¢">3. ä¾æ ·ç”»ç“¢</h1>

<p>æš´åŠ›å†™æ³•å…¶å®ä¹Ÿå¯ä»¥ï¼Œä¹ŸæŒ‘ä¸å‡ºä»€ä¹ˆæ¯›ç—…ã€‚ä½†æ˜¯è¿™æ®µæ—¶é—´æˆ‘å¯æ˜¯åœ¨çœ‹è®¾è®¡æ¨¡å¼ï¼Œæ€ä¹ˆä¹Ÿå¾—å†™ä¸ªå·¥å‚åŠæ³•ä¹‹ç±»çš„æŠŠï¼Œäºæ˜¯å˜æˆå¦‚ä¸‹è¿™æ ·ï¼š</p>

<p>å®šä¹‰äº†å¤„ç†æ•°æ®çš„æ¥å£</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type msgHandle interface{
   handle(msg Msg)
}

</code></pre></div></div>

<p>æ¯ä¸ªéœ€è¦å¤„ç† key çš„ç¨‹åºéƒ½éœ€è¦å®ç°è¯¥æ¥å£(é¸­å­ç±»å‹)</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type handle10001 struct {

}

func(h handle10001) handle(msg Msg){
   // todo å¤„ç†é€»è¾‘
}

type handle10002 struct {

}

func(h handle10002) handle(msg Msg){
   // todo å¤„ç†é€»è¾‘
}

type handle10003 struct {

}

func(h handle10003) handle(msg Msg){
   // todo å¤„ç†é€»è¾‘
}

</code></pre></div></div>

<p>å› æ­¤å¤„ç†çš„é€»è¾‘å˜æˆäº†</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func cus(msg Msg){

   // è¿™æ®µå°è£…èµ·æ¥å°±æ˜¯ä¸€ä¸ªå·¥å‚
   var msgh msgHandle
   if msg.key == "10001"{
      msgh = handle10001{}
   }else if msg.key == "10002"{
      msgh = handle10002{}
   }else if msg.key == "10003"{
      msgh = handle10003{}
   }

   // çœŸæ­£å¤„ç†è¿‡ç¨‹
   msgh.handle(msg)
}

</code></pre></div></div>

<p><br /></p>
<h1 id="4-è¿›è¡Œä¼˜åŒ–">4. è¿›è¡Œä¼˜åŒ–</h1>

<p>ä¸Šé¢å°±æ˜¯å­¦äº†è®¾è®¡æ¨¡å¼çš„äººçš„é€šç—…ï¼Œæœ‰äº†é”¤å­ï¼Œå•¥éƒ½æ˜¯é’‰å­ã€‚é‚£æ ·å†™è™½ç„¶çœ‹èµ·æ¥å¥½åƒä¸é”™ï¼Œå®é™…ä¸Šå’Œä¹‹å‰çš„å¹¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚</p>

<p>ä¸è¿‡ï¼Œå·¥å‚æ¨¡å¼å…¶å®å¯ä»¥é€šè¿‡ map å»ä¼˜åŒ–ï¼Œä¼˜åŒ–åå¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mmp := make(map[string]msgHandle)
mmp["10001"] = handle10001{}
mmp["10002"] = handle10002{}
mmp["10003"] = handle10003{}

</code></pre></div></div>

<p>è°ƒç”¨ç¨‹åºå°±æ˜¾å¾—æ›´åŠ ç®€å•ç›´è§‚ï¼Œå¢åŠ å…¶ä»–çš„ key åªéœ€è¦ä¿®æ”¹ map, ç„¶åç¼–å†™å¯¹åº”çš„ç»“æ„ä½“</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func cus(msg Msg){
   msgh, _ := mmp[msg.key]
   msgh.handle(msg)
}
</code></pre></div></div>

<p><br /></p>
<h1 id="5-è€ƒè™‘æ¼”è¿›">5. è€ƒè™‘æ¼”è¿›</h1>

<p>å°±è¿™æ ·æˆ‘å†™äº†å¤„ç† 10001 çš„ä»£ç ã€‚è¿™æ—¶å€™ï¼ŒåŒäº‹å°å³°å¯¹æˆ‘è¯´ï¼Œä»–ä¹Ÿè¦å¤„ç†10001, è€Œä¸”å’Œæˆ‘çš„å¤„ç†æ–¹å¼ä¸åŒã€‚æˆ‘å°±è·Ÿä»–è¯´ï¼Œé‚£ä½ å°è£…ä¸ªåŠæ³•ï¼Œå†™åœ¨æˆ‘ä¸‹é¢æŠŠï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type handle10001 struct {

}

func(h handle10001) handle(msg Msg){
   // todo æˆ‘çš„å¤„ç†é€»è¾‘

   // å°å³°çš„
   xiaofengHandle(msg Msgs)
}


func xiaofengHandle(msg Msg){

}

</code></pre></div></div>

<p>ç›¸ä¿¡è¿™æ®µä»£ç å¾ˆå®¹æ˜“çœ‹å‡ºå¼Šç«¯ï¼Œç°åœ¨åªæœ‰å°å³°ï¼Œä»¥åè¿˜æœ‰å°å¿—ï¼Œå°æºï¼Œä»–ä»¬éƒ½è¦å¤„ç† 10001ï¼Œè€Œä¸”å¤„ç†çš„æ–¹å¼å®Œå…¨ä¸ä¸€æ ·ï¼Œæ€ä¹ˆåŠï¼Ÿ</p>

<p>ä¸€æ—¦äººå¤šèµ·æ¥ï¼ŒåŠæ³•å°±å˜å¾—è‡ƒè‚¿ï¼Œè€Œä¸”æˆ‘æ¯æ¬¡è¦æ”¹è‡ªå·±çš„ä»£ç ï¼Œéƒ½è¦çœ‹æœ‰æ²¡æœ‰åŠ¨åˆ°åˆ«äººçš„ä»£ç ï¼Œå¢åŠ äº†å¿ƒæ™ºè´Ÿæ‹…ã€‚å¦å¤–ï¼Œå¦‚æœæˆ‘ panic äº†ï¼Œä¸‹é¢çš„ä»£ç éƒ½æ‰§è¡Œä¸åˆ°äº†ï¼Œæˆ‘æ€•æ˜¯è¦è¢«äººç¾¤æ®´ã€‚</p>

<p>è¿™æ—¶å€™æˆ‘çªç„¶æƒ³åˆ°ï¼Œå¯ä»¥ç”¨å‘å¸ƒè®¢é˜…çš„è®¾è®¡æ¨¡å¼ï¼Œæˆ‘ä»¬åœ¨ä»£ç å±‚é¢ï¼Œä¸åŒçš„ key ä½œä¸ºä¸€ä¸ªäº‹ä»¶ï¼Œåˆ«äººéƒ½æ¥è®¢é˜…ï¼Œæ¶ˆè´¹è¯¥ key çš„æ—¶å€™é€šçŸ¥æ‰€æœ‰çš„è®¢é˜…è€…ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type handle10001 struct {
   observerList []observer
}

func(h handle10001) addObserver(ob observer) {
   h.observerList = append(h.observerList, ob)
}

func(h handle10001) handle(msg Msg){
   for _,o := range h.observerList {
      o.update(msg)
   }
}

type observer interface{
   update(msg Msg)
}

type my10001observer struct {
}

func(my my10001observer) update(msg Msg)  {
   // æˆ‘å¯¹100001çš„å¤„ç†
}

type xiaoFeng10001observer struct {
}

func(xiaofeng xiaoFeng10001observer) update(msg Msg)  {
   // å°å³°å¯¹100001çš„å¤„ç†
}

</code></pre></div></div>

<p>æ‰§è¡Œå¦‚ä¸‹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// è¿™é‡Œçš„åˆå§‹åŒ–å¯ä»¥æ”¾åœ¨ init é‡Œ
obs := handle10001{[]observer{}} 
obs.addObserver(my10001observer{}) // æˆ‘çš„
obs.addObserver(xiaoFeng10001observer{}) // å°å³°çš„
mmp["10001"] = obs

// 10002
obs2 := handle10002{[]observer{}} 
obs2.addObserver(my10002observer{})
mmp["10002"] = obs2


// åŠæ³•
func cus(msg Msg){
   obs, _ := mmp[msg.key]
   obs.handle(msg)// é€šçŸ¥è¦å¤„ç†çš„äºº
}

</code></pre></div></div>

<p>handle åŠæ³•è¿™æ ·å†™è¿˜å¯ä»¥é¿å…ä¸¤äººçš„ pannic äº’ç›¸å½±å“ï¼Œå¦‚æœä¸è¿›è¡Œä¸Šé¢çš„å°è£…ï¼Œè¿™ç‚¹æ ¹æœ¬åšä¸åˆ°ã€‚å¥½å¤„å·²ç»æ˜¾ç°å‡ºæ¥äº†ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func handleWithCoverPanic(obs observer, msg Msg) {
   defer func() {
      if err := recover(); err != nil {
         // å¤„ç† panic
      }
   }()
   obs.update(msg)
}

func(h handle10001) handle(msg Msg){
   for _,o := range h.observerList {
      handleWithCoverPanic(o,msg)
   }
}

</code></pre></div></div>

<p><br /></p>
<h1 id="6-å†ä¸€æ¬¡å°è£…">6. å†ä¸€æ¬¡å°è£…</h1>
<p>å…¶å®ä¸Šé¢çš„ä»£ç å·²ç»ç¬¦åˆå¼€æ”¾å°é—­åŸåˆ™äº†ï¼Œå¢åŠ æ–°çš„ key åªéœ€è¦å®ç°æ–°çš„   msgHandleï¼Œç„¶åæ³¨å†Œåˆ° map é‡Œã€‚åˆ«äººæƒ³å¤„ç†åŒæ ·çš„ key ä¹Ÿåªéœ€è¦å®ç°æ–°çš„ Observerï¼Œç„¶åç™»è®°åˆ°å¯¹åº”çš„ msgHandle ä¸Šã€‚ä¸åŒçš„äººä¸éœ€è¦åŠ¨åˆ°å…¶ä»–äººçš„ä»£ç ã€‚</p>

<p>ä½†æ˜¯ä»”ç»†çœ‹äº†å¥½åƒåˆ›å»ºäº†è¿‡å¤šçš„ç»“æ„ä½“ã€‚å®é™…ä¸Šï¼Œgo è¯­è¨€å¯ä»¥èƒ½ç›´æ¥æŠŠå‡½æ•°å½“å‚æ•°çš„ï¼Œä¸ºå•¥æˆ‘è¦è¿™ä¹ˆéº»çƒ¦åˆ›å»ºç»“æ„ä½“å‘¢ï¼Ÿä¸è¦è¢«åˆ«çš„è¯­è¨€æ‰€æŸç¼šï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type msgHandle2 struct {
   Methods map[string][]func(msg Msg) // key æ˜¯è¦æ¶ˆè´¹çš„ key, val æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªåŠæ³•çš„æ•°ç»„
}

func (mgsh *msgHandle2) AddMethod(key string, fn func(msg Msg)) {
   mgsh.Methods[key] = append(mgsh.Methods[key], fn)
}

func (mgsh *msgHandle2) handle(key string, msg Msg) {

   for _, v := range mgsh.Methods[key] {
      handleWithRecover(v, msg)
   }
}

func handleWithRecover(fn func(msg Msg), msg Msg) {
   defer func() {
      if err := recover(); err != nil {
      
      }
   }()
   fn(msg)
}

// æˆ‘çš„å¤„ç†
func myHandle10001(msg Msg) {
   
}

// å°å³°çš„å¤„ç†
func xiaoFengHandle10001(msg Msg) {

}
var msgh2 msgHandle2

func init() {
   //åˆå§‹åŒ–
   msgh2 = msgHandle2{make(map[string][]func(msg Msg))}

   // 10001
   msgh2.AddMethod("10001", myHandle10001) // æˆ‘å¯¹ 10001 çš„å¤„ç†
   msgh2.AddMethod("10001", xiaoFengHandle10001) // å°å³°å¯¹ 10001 çš„å¤„ç†

   // 10002 
   msgh2.AddMethod("10002", myHandle10002) // æˆ‘å¯¹ 10002 çš„å¤„ç†

   // 10003  
   ....

   // å¢åŠ æ–°çš„ key å’Œ åŠæ³•ï¼Œä¸éœ€è¦æ”¹ä¸Šé¢çš„ã€‚
   // æœ‰ä¸€å¤©æˆ‘ä¸æƒ³å¤„ç† 10001ï¼Œåªéœ€è¦æ³¨é‡Šæ‰æˆ‘çš„é‚£è¡Œä»£ç 
   // è¿™çœ‹èµ·æ¥æœ‰ç‚¹åƒ gin æ¡†æ¶çš„è·¯ç”±æ³¨å†Œ
}


</code></pre></div></div>
<p>è¿™é‡Œç¨å¾®è§£é‡Šä¸‹ï¼Œä¸Šé¢å…¶å®æ˜¯å®šä¹‰ä¸€ä¸ªäº†ä¸€ä¸ªè¿™æ ·çš„ mapã€‚â€10001â€ =&gt; [â€œåŠæ³•1â€ï¼Œâ€åŠæ³•2â€], â€œ10002â€ =&gt; [â€œåŠæ³•3â€ï¼Œâ€åŠæ³•4â€]ï¼Œæ ¹æ® key å®šä½åˆ°æ•°ç»„ï¼Œéå†æ‰§è¡Œæ•°ç»„é‡Œçš„åŠæ³•ã€‚</p>

<p>å¤„ç†å¦‚ä¸‹ï¼Œåªå‰©ä¸‹ä¸€å¥è¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func cus(msg Msg){
  msgh2.handle(msg.key, msg)
}

</code></pre></div></div>

<p>ä½ ä¼šå‘ç°ï¼Œæœ€ç»ˆä½ å¹¶ä¸èƒ½è¯´æˆ‘ç©¶ç«Ÿç”¨äº†å“ªå‡ ç§è®¾è®¡æ¨¡å¼ï¼Œä½†æ˜¯æ¼”è¿›çš„è¿‡ç¨‹å´æ˜¯å‚è€ƒäº†è®¾è®¡æ¨¡å¼çš„æƒ³æ³•ã€‚ä¸åŒè¯­è¨€å¯¹äºè®¾è®¡æ¨¡å¼çš„ä»£ç è¯ é‡Šä¹Ÿä¸ä¸€å®šä¸€æ ·ã€‚</p>

<p><br /></p>
<h1 id="7-æ€»ç»“">7. æ€»ç»“</h1>
<p>ä¸€ç‚¹å°æ€»ç»“</p>

<ul>
  <li>å†™ä»£ç ä»æœ€ç®€å•å…¥æ‰‹ï¼Œæš´åŠ›çš„å†™æ³•æ»¡è¶³çš„è¯ï¼Œå¯ä»¥ä¸ç”¨è¿‡åº¦ä¼˜åŒ–ã€‚</li>
  <li>è¿›è¡Œè¿­ä»£çš„æ—¶å€™ï¼Œå‘ç°æœ‰é—®é¢˜äº†ï¼Œå¯ä»¥å¼€å§‹å°è¯•å°è£…ï¼Œä¸ç„¶ä½ ä¸çŸ¥é“èƒ½æ¼”å˜æˆä»€ä¹ˆæ ·å­ã€‚</li>
  <li>ä»£ç æ˜¯æ¼”è¿›çš„ï¼Œä¸æ˜¯ä¸€è¹´è€Œå°±ï¼Œåˆ«äººçš„æ¡†æ¶äº¦æ˜¯å¦‚æ­¤ã€‚</li>
  <li>ä¸è¦æ‹˜æ³¥äºè¯­è¨€æˆ–è€…è®¾è®¡æ¨¡å¼ï¼Œä¸åŒè¯­è¨€å¯èƒ½å†™å‡ºæ¥ä¸æ˜¯å¾ˆä¸€æ ·ï¼Œä½†æ˜¯æ ¸å¿ƒæ€æƒ³ä¹Ÿéƒ½æ˜¯è®¾è®¡æ¨¡å¼è¯´çš„å¼€æ”¾å°é—­åŸåˆ™ã€‚ç”¨å¤§ç™½è¯è¯´ï¼Œå°±æ˜¯å¢åŠ æ–°çš„åŠŸèƒ½ï¼Œä¸éœ€è¦æœ‰çœ‹åˆ«äººçš„ä»£ç ï¼Œä¸éœ€è¦æ”¹åˆ«äººçš„ä»£ç ï¼Œä¸éœ€è¦æœ‰è¿‡å¤šçš„å¿ƒæ™ºè´Ÿæ‹…ã€‚</li>
</ul>

:ET