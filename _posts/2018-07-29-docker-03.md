---
layout: default_post
title : 第一个docker化的Java项目（分类：从0开始docker学习）
---


前言：上次简单启动了一个 Nginx 服务器容器，并成功访问到服务器。现在来试试，如何将一个项目放进 Tomcat 容器里并访问到。

<br>
## 导航
1. 准备工作
1. 要理解的概念
1. 下载需要的容器+项目
1. 编写 Dockerfile
1. 运行并测试
1. 常见指令
1. 总结

<br>
# 1.准备工作
确保电脑和云主机能实现文件传输，方便把自己的项目传输到服务器。有两种方案：
- 1.使用 GitHub、码云等代码托管网站作为中转站
- 2.使用 Xftp 等工具进行传输

<br>
这里我选择的是第一种，首先在云服务器上安装git。这里我直接安装已经编译好的git：
>yum install git-core

<html>
<a href="https://git-scm.com/book/zh/v2/%E8%B5%B7%E6%AD%A5-%E5%AE%89%E8%A3%85-Git" target="_blank">[其他方式参考：Git官网安装教程]</a>
</html>
<br>
然后是将要运行的项目从本地电脑上传到 GitHub 上，然后云服务器再从 GitHub 拉取下来，至于如何使用 git 和 GitHub ，网上的教程也很多，这里不累述。

<br>
# 2.要理解的概念
理解下面的概念，才能更好地进行下去。

<br>
#### 1. Dockerfile 文件
之前我们下载的都是镜像文件，那么镜像文件是如何生成的呢，没错，就是 Dockerfile。 Dockerfile 是一个文本文件，用来配置 image。Docker 根据 该文件去生成二进制的 image 文件，这里不理解没关系，实际操作就知道了。

<br>
#### 2. docker 的镜像继承
这是一个很重要的概念，只有明白这个概念，我们才能使用别人的镜像，去制作自己的镜像。下图从下往上便是一个容器的生命周期。

![image](http://p2pko6fd6.bkt.clouddn.com/18-07-29@01.png)

可以先把容器想象成一个简单的虚拟机，底层是一个操作系统的引导，往上是 Debian 和 BusyBox ，暂时简单理解为一套简易的 Linux 操作系统。

往上就是文件系统，存放我们想要的软件了。比如存放软件 emacs 后，其实就可以作为一个拥有 emacs 功能的镜像了。这时候想再增加一个软件 apache ，而又不想更改原有的镜像，就可以继承上一个镜像，再增加 apache ，以此类推。

镜像运行成容器的时候，会从下往上逐层加载，最终这些文件系统都会在同个文件系统下（原理是 Linux 的联合文件系统），也正是由于是从下往上加载，所以我们可以继承别人的镜像后，做出个性化的修改，覆盖掉父镜像的一些东西。

最终，镜像会运行，生成容器，镜像是只读的，只有生成的容器才是可以修改的，所以同个镜像可以生成多个的容器，并且不会互相干扰。

<br>
#### 3.docker容器的内部
上面说到，其实容器的最底层类似一个简易的 Linux 操作系统，所以具备 Linux 的基本功能。
以上次运行的 ngnix 为例，在 ngnix 容器运行的情况下，输入以下指令：
>docker exec -it 容器名  bash

这样就进入到容器内部，使用 ls 指令可以发现，这就是一个小型Linux系统。

```
bin  boot  dev	etc  home  lib	lib32  lib64  libx32  media  mnt  opt  proc  root  run	sbin  srv  sys	tmp  usr  var
```

<br>
#### 4.将项目放进容器的两种办法
以将 war 包放进容器中的 Tomcat 为例:

- 1.将 war 包直接 copy 进容器内的 Tomcat 的 webapps 下（下面会演示）。
- 2.也可以在镜像启动为容器时，使用 docker 的目录映射，将 Tomcat 的 webapps 目录映射到容器外的目录 a，将项目放进这个目录 a 即可。

<br>
#### 5. docker 环境三种搭建方式
假设使用 docker 创建一个开发环境，比如 Tomcat + MySQL ，我们有以下几种做法：
- 1.自己从底层开始搭起，制作同时包含 Tomcat + MySQL 的镜像，但是这样学习成本很高。
- 2.分别下载官方或他人制作的 Tomcat 及 MySQ L镜像（然后继承改写），分别启动。
- 3.依旧是使用官方的 Tomcat 和 MySQL 镜像（继承改写），但是使用 docker-compose 管理容器间的依赖关系，设置好后可以同时启动或关闭。

上面只是简单讲一下理论，实际上容器间如果存在关联关系，还需要很多额外的设置，这些需要不断地学习才能明白。

接下来，本着由简入繁的态度，我们使用官方的镜像，来搭建自己的 Tomcat + MySQL 环境，并运行 jpress（这是 GitHub 上一个可快速搭建博客的开源项目）。

<br>
# 3.下载需要的容器+项目
<br>
#### 1.下载 Tomcat
>docker pull hub.c.163.com/library/tomcat:latest

由于是官方封装好的镜像，里面也附带了jdk等依赖，几乎一下来就可以使用了。

<br>
#### 2.下载 MySQL
>docker pull hub.c.163.com/library/mysql:latest

<br>
#### 3.上传你的项目
可以将 jpress 或者你自己的项目的 war 包上传到你自己的 GitHub 上，再用
>git clone 你的项目网址

将项目克隆到云主机上，这里我不使用自己的项目，直接用 jpress。


<br>
# 4.编写 Dockerfile
<br>
#### 1.首先，新建一个文件夹 jpress
>mkdir jpress

<br>
#### 2.将  jpress-web-newest.war 放进文件夹 jpree 中, 并改个短名 jpress.war
>cp  原路径 / jpress-web-newest.war jpress  / jpress.war

<br>
#### 3.新建一个 Dockerfile
>vi Dockerfile

<br>
#### 4.加入如下内容
```
from hub.c.163.com/library/tomcat
COPY ./jpress.war /usr/local/tomcat/webapps 
```
                         
- from，指明是基于（继承）刚才下载的 Tomcat 的 image 去构建我们自己 image 。
- COPY，指的是，启动容器后，将当前目录下的 jpress.war 拷贝进入容器的 /usr/local/tomcat/webapps。webapps 就是容器内部 Tomcat 存放 JavaWeb 项目的地方，至于这个路径怎么来的，要不就进入容器内部看，要不就看镜像作者提供的文档。

<br>
# 5.运行并测试

<br>

1. 第一步，进入刚才存放 Dockerfile 的文件夹中，运行如下命令，指定名称为 jpress，版本为 latest:
>docker build -t  jpress:latest .

<br>

2. 第二步，启动容器（启动后查看端口是否监听中可以用 netstat -na|grep 8888）
>docker run -d -p 8888:8080 jpress


<br>

3. 第三步，启动数据库（账号默认为root，设置密码用-e MYSQL_ROOT_PASSWORD）
>docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 hub.c.163.com/library/mysql:latest

<br>

4.通过 ip + 8888 访问并设置博客配置，最终生成一个博客网站

<br>
![image](http://p2pko6fd6.bkt.clouddn.com/18-07-29@02.png)
![image](http://p2pko6fd6.bkt.clouddn.com/18-07-29@03.png)

<br>
至此，一个 docker 化的 JavaWeb 应用成功！！！！

<br>
# 6.常见指令

要注意的是，每个容器有自己的独特的 ID 和 NAME，每次 run 其实是生成一个新容器，并不会共享旧容器内部被修改的数据。下面介绍一些常见命令：

<br>
1.列出所有容器，包括关闭的
>docker ps -a

>docker ps -a -q

<br>
2.关闭指定容器
>docker kill 容器名 或者 id前几位

>docker stop 容器名 或者 id前几位

<br>
3.开启指定容器
>docker start 容器名 或者 id前几位

<br>
4.删除指定容器
>docker rm 容器名 或者 id前几位 

<br>
5.关闭所有容器
>docker stop $(docker ps -a -q)

<br>
6.删除所有容器（慎用）
>docker rm $(docker ps -a -q)



<br>
# 6.总结
<br>
不严谨的总结一下：
- 镜像 == Dockerfile + 应用 + 基于包含操作系统的父级镜像+ 转换成二进制
- 容器 == 镜像生成的 + 一个简易的操作系统 + 跑着一些应用

<br>

##### 后话：事实上，上面只是罗列过程，完整走下来其实坑还是很多的，比如tomcat启动十几分钟如何解决等等问题......也是搞了好一阵子，这些坑后面再慢慢讲，接下来还有更多的坑等着......加油！！！

